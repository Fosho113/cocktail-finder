<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Ensure proper scaling on mobile devices -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Cocktail Recipe Finder</title>
  <style>
    /* Global Styles */
    body {
      margin: 0;
      padding: 0;
      font-family: Arial, sans-serif;
      background: #f4f4f4;
      color: #333;
    }
    /* Navigation Bar */
    nav {
      background: #007BFF;
      color: #fff;
      padding: 10px;
      text-align: center;
    }
    nav a {
      color: #fff;
      margin: 10px;
      text-decoration: none;
      font-weight: bold;
    }
    nav a.active {
      text-decoration: underline;
    }
    /* Main Container */
    .container {
      max-width: 800px;
      margin: 20px auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    h1 {
      text-align: center;
    }
    /* Form Controls */
    label {
      font-weight: bold;
    }
    input[type="text"],
    select,
    textarea {
      width: 100%;
      padding: 10px;
      font-size: 16px;
      margin: 10px 0;
      border-radius: 4px;
      border: 1px solid #ccc;
    }
    button {
      padding: 10px 20px;
      font-size: 16px;
      margin: 10px 0;
      cursor: pointer;
      border: none;
      border-radius: 4px;
      background: #007BFF;
      color: #fff;
    }
    button:hover {
      background: #0056b3;
    }
    /* Ingredient Tag List */
    #ingredientList {
      list-style: none;
      padding: 0;
    }
    #ingredientList li {
      background: #e9e9e9;
      padding: 5px;
      margin: 5px;
      display: inline-block;
      border-radius: 4px;
    }
    #ingredientList li span.remove {
      margin-left: 10px;
      color: red;
      cursor: pointer;
    }
    /* Responsive Video Embed */
    .video-container {
      position: relative;
      padding-bottom: 56.25%;
      height: 0;
      overflow: hidden;
      margin-top: 20px;
    }
    .video-container iframe {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }
    /* Sections */
    .section {
      display: none;
    }
    .section.active {
      display: block;
    }
    /* Reviews */
    .review {
      border-top: 1px solid #ccc;
      margin-top: 10px;
      padding-top: 10px;
    }
    /* Favorites List styling */
    .fav-item {
      border: 1px solid #ccc;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 8px;
    }
    /* Step-by-step instructions */
    .steps {
      margin-top: 10px;
    }
    .step {
      margin: 10px 0;
    }
    .step img {
      width: 100%;
      border-radius: 8px;
    }
    @media (max-width: 600px) {
      .container { padding: 15px; }
      button { font-size: 18px; }
    }
  </style>
</head>
<body>
  <!-- Navigation Bar -->
  <nav>
    <a href="#" class="nav-link active" data-section="findSection">Find Cocktail</a>
    <a href="#" class="nav-link" data-section="favoritesSection">Favorites</a>
    <a href="#" class="nav-link" data-section="analyticsSection">Analytics</a>
  </nav>

  <div class="container">
    <!-- Find Cocktail Section -->
    <section id="findSection" class="section active" role="main">
      <h1>Cocktail Recipe Finder</h1>
      <!-- Ingredient Input with Auto-Complete -->
      <div>
        <label for="ingredientInput">Add Ingredient:</label>
        <input type="text" id="ingredientInput" list="ingredientSuggestions" aria-label="Ingredient Input" placeholder="Type an ingredient" />
        <datalist id="ingredientSuggestions">
          <option value="Vodka"></option>
          <option value="Gin"></option>
          <option value="Rum"></option>
          <option value="Tequila"></option>
          <option value="Triple Sec"></option>
          <option value="Bourbon"></option>
          <option value="Whiskey"></option>
          <option value="Lime Juice"></option>
          <option value="Lemon Juice"></option>
          <option value="Orange Juice"></option>
          <option value="Cola"></option>
          <option value="Simple Syrup"></option>
          <option value="Mint"></option>
          <option value="Cranberry Juice"></option>
          <option value="Grenadine"></option>
          <option value="Peach Schnapps"></option>
        </datalist>
        <button id="addIngredientBtn">Add Ingredient</button>
      </div>
      <!-- Display Added Ingredients -->
      <ul id="ingredientList" aria-label="List of added ingredients"></ul>
      
      <!-- Flavor Profile Selection -->
      <div>
        <p>Select Flavor Profiles (optional):</p>
        <label><input type="checkbox" class="flavor-checkbox" value="sweet" /> Sweet</label>
        <label><input type="checkbox" class="flavor-checkbox" value="tart" /> Tart</label>
        <label><input type="checkbox" class="flavor-checkbox" value="dry" /> Dry</label>
      </div>
      
      <!-- Action Buttons -->
      <div>
        <button id="findCocktailBtn">Find Cocktail</button>
        <button id="findLocalBarsBtn">Find Local Bars</button>
      </div>
      
      <!-- Result Container -->
      <div id="result"></div>
    </section>
    
    <!-- Favorites Section -->
    <section id="favoritesSection" class="section" role="main">
      <h1>Your Favorites</h1>
      <div id="favoritesList"></div>
    </section>
    
    <!-- Analytics Section (Admin Dashboard) -->
    <section id="analyticsSection" class="section" role="main">
      <h1>Analytics Dashboard</h1>
      <div id="analyticsData"></div>
    </section>
  </div>

  <script>
    /**********************
     * GLOBAL VARIABLES
     **********************/
    let ingredients = [];
    // Flavor keywords for matching – these can be expanded over time.
    const flavorKeywords = {
      "sweet": ["sweet", "mojito", "daiquiri", "colada", "piña"],
      "tart": ["tart", "margarita", "sour"],
      "dry": ["dry", "martini", "gin", "tonic", "old fashioned"]
    };

    /**********************
     * NAVIGATION LOGIC
     **********************/
    document.querySelectorAll('.nav-link').forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault();
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        e.target.classList.add('active');
        const section = e.target.getAttribute('data-section');
        document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
        document.getElementById(section).classList.add('active');
        if (section === "favoritesSection") {
          loadFavorites();
        } else if (section === "analyticsSection") {
          loadAnalytics();
        }
      });
    });

    /**********************
     * INGREDIENT MANAGEMENT
     **********************/
    const ingredientInput = document.getElementById('ingredientInput');
    const ingredientListEl = document.getElementById('ingredientList');

    document.getElementById('addIngredientBtn').addEventListener('click', () => {
      const ing = ingredientInput.value.trim();
      if (ing && !ingredients.includes(ing.toLowerCase())) {
        ingredients.push(ing.toLowerCase());
        updateIngredientList();
      }
      ingredientInput.value = '';
    });

    function updateIngredientList() {
      ingredientListEl.innerHTML = '';
      ingredients.forEach((ing, index) => {
        const li = document.createElement('li');
        li.textContent = ing;
        const span = document.createElement('span');
        span.textContent = '✕';
        span.className = 'remove';
        span.setAttribute('aria-label', 'Remove ingredient');
        span.addEventListener('click', () => {
          ingredients.splice(index, 1);
          updateIngredientList();
        });
        li.appendChild(span);
        ingredientListEl.appendChild(li);
      });
    }

    /**********************
     * LOCAL BARS GEOLICATION
     **********************/
    document.getElementById('findLocalBarsBtn').addEventListener('click', () => {
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(position => {
          const { latitude, longitude } = position.coords;
          const mapsUrl = `https://www.google.com/maps/search/bars+near+${latitude},${longitude}`;
          window.open(mapsUrl, '_blank');
        }, error => {
          alert("Geolocation error: " + error.message);
        });
      } else {
        alert("Geolocation is not supported by your browser.");
      }
    });

    /**********************
     * FIND COCKTAIL (ADVANCED FILTERING)
     **********************/
    document.getElementById('findCocktailBtn').addEventListener('click', async () => {
      if (ingredients.length === 0) {
        alert("Please add at least one ingredient.");
        return;
      }
      
      // Get selected flavor profiles (if none selected, we treat it as "any")
      const selectedFlavors = Array.from(document.querySelectorAll('.flavor-checkbox:checked')).map(cb => cb.value);
      
      // Use the first ingredient for API filtering
      const primaryIngredient = ingredients[0];
      const filterUrl = `https://www.thecocktaildb.com/api/json/v1/1/filter.php?i=${encodeURIComponent(primaryIngredient)}`;
      
      try {
        const response = await fetch(filterUrl);
        const data = await response.json();
        if (!data.drinks) {
          document.getElementById('result').innerHTML = `<p>No cocktails found with "${primaryIngredient}".</p>`;
          return;
        }
        // Fetch detailed information for each returned cocktail.
        const detailedDrinks = await Promise.all(
          data.drinks.map(async drink => {
            const detailUrl = `https://www.thecocktaildb.com/api/json/v1/1/lookup.php?i=${drink.idDrink}`;
            try {
              const resp = await fetch(detailUrl);
              const detailData = await resp.json();
              if(detailData.drinks && detailData.drinks[0]) {
                return detailData.drinks[0];
              }
            } catch(e) {
              console.error("Error fetching details for ", drink.idDrink, e);
            }
            return null;
          })
        );
        const availableDrinks = detailedDrinks.filter(drink => drink !== null);
        
        // Advanced multi-ingredient scoring based on user ingredients.
        availableDrinks.forEach(drink => {
          let score = 0;
          let drinkIngredients = [];
          for (let i = 1; i <= 15; i++) {
            const ing = drink[`strIngredient${i}`];
            if (ing) {
              drinkIngredients.push(ing.toLowerCase());
            }
          }
          ingredients.forEach(userIng => {
            if (drinkIngredients.includes(userIng)) {
              score++;
            }
          });
          drink.matchScore = score;
          
          // Flavor matching: if flavors are selected, check if the cocktail’s name or instructions match any flavor keywords.
          if (selectedFlavors.length > 0) {
            let flavorMatch = false;
            const text = (drink.strDrink + " " + (drink.strInstructions || "")).toLowerCase();
            selectedFlavors.forEach(flavor => {
              const keywords = flavorKeywords[flavor] || [];
              if (keywords.some(keyword => text.includes(keyword))) {
                flavorMatch = true;
              }
            });
            drink.flavorMatch = flavorMatch;
          } else {
            drink.flavorMatch = true;
          }
        });
        
        // Filter out drinks that fail the flavor filter (if any flavors were selected).
        let filteredDrinks = availableDrinks.filter(drink => drink.flavorMatch);
        if (filteredDrinks.length === 0) {
          filteredDrinks = availableDrinks;
        }
        
        // Sort by the matchScore (higher scores on top)
        filteredDrinks.sort((a, b) => b.matchScore - a.matchScore);
        const chosenCocktail = filteredDrinks[0];
        
        if (!chosenCocktail) {
          document.getElementById('result').innerHTML = `<p>No matching cocktail found.</p>`;
          return;
        }
        
        // Update Analytics (increment view count)
        updateAnalytics(chosenCocktail.idDrink, chosenCocktail.strDrink);
        
        displayCocktail(chosenCocktail);
        
      } catch (error) {
        console.error("Error:", error);
        document.getElementById('result').innerHTML = `<p>An error occurred while fetching the cocktail.</p>`;
      }
    });

    /**********************
     * ANALYTICS: Increment & Store Views
     **********************/
    function updateAnalytics(cocktailId, cocktailName) {
      let analytics = JSON.parse(localStorage.getItem('analytics')) || {};
      if (!analytics[cocktailId]) {
        analytics[cocktailId] = { name: cocktailName, views: 0 };
      }
      analytics[cocktailId].views += 1;
      localStorage.setItem('analytics', JSON.stringify(analytics));
    }

    /**********************
     * DISPLAY COCKTAIL DETAILS
     **********************/
    function displayCocktail(cocktail) {
      const resultDiv = document.getElementById('result');
      
      // Determine proper video URL (using embed if necessary)
      let videoLink = cocktail.strVideo || cocktail.strYoutube || "";
      if (videoLink) {
        if (videoLink.includes("watch?v=")) {
          videoLink = videoLink.replace("watch?v=", "embed/");
        }
      } else {
        videoLink = "https://www.youtube.com/embed/zCtDil5CsVI"; // default video
      }
      
      resultDiv.innerHTML = `
        <h2>${cocktail.strDrink}</h2>
        <div class="video-container">
          <iframe src="${videoLink}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen title="${cocktail.strDrink} Video"></iframe>
        </div>
        <p>${cocktail.strInstructions || "No instructions available."}</p>
        <img src="${cocktail.strDrinkThumb}" alt="${cocktail.strDrink}" style="width:100%; border-radius:8px; margin-top:20px;">
        <div>
          <button id="favoriteBtn" class="favorite-btn"></button>
          <button id="shareBtn">Share Cocktail</button>
          <button id="toggleStepsBtn">View Step-by-Step</button>
        </div>
        <div id="steps" class="steps" style="display:none;"></div>
        <div id="reviewsSection">
          <h3>Ratings and Reviews</h3>
          <div id="reviewDisplay"></div>
          <form id="reviewForm">
            <label for="rating">Rating:</label>
            <select id="rating" required>
              <option value="">Select a rating</option>
              <option value="1">1 Star</option>
              <option value="2">2 Stars</option>
              <option value="3">3 Stars</option>
              <option value="4">4 Stars</option>
              <option value="5">5 Stars</option>
            </select>
            <br>
            <label for="reviewText">Review:</label>
            <textarea id="reviewText" rows="3" placeholder="Write your review here..." required></textarea>
            <br>
            <button type="submit">Submit Review</button>
          </form>
        </div>
      `;
      
      // Favorite button: check localStorage and update accordingly.
      const favBtn = document.getElementById('favoriteBtn');
      const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
      if (favorites.includes(cocktail.idDrink)) {
        favBtn.textContent = "Remove from Favorites";
      } else {
        favBtn.textContent = "Add to Favorites";
      }
      favBtn.addEventListener('click', () => toggleFavorite(cocktail));
      
      // Share button: use Web Share API or fallback.
      document.getElementById('shareBtn').addEventListener('click', () => shareCocktail(cocktail));
      
      // Toggle step-by-step instructions.
      document.getElementById('toggleStepsBtn').addEventListener('click', () => toggleSteps(cocktail));
      
      // Load reviews (from localStorage)
      loadReviews(cocktail.idDrink);
      
      // Setup review form submission
      document.getElementById('reviewForm').addEventListener('submit', (e) => {
        e.preventDefault();
        submitReview(cocktail.idDrink);
      });
    }

    /**********************
     * STEP-BY-STEP INSTRUCTIONS TOGGLE
     **********************/
    function toggleSteps(cocktail) {
      const stepsDiv = document.getElementById('steps');
      if (stepsDiv.style.display === 'none') {
        // For simplicity, split instructions by period (".") and display each step with a placeholder image.
        const steps = (cocktail.strInstructions || "").split('.').filter(step => step.trim() !== "");
        let html = "<h3>Step-by-Step Instructions:</h3>";
        steps.forEach((step, index) => {
          html += `<div class="step">
                     <p><strong>Step ${index + 1}:</strong> ${step.trim()}.</p>
                     <img src="https://via.placeholder.com/600x400?text=Step+${index + 1}" alt="Step ${index + 1} Image">
                   </div>`;
        });
        stepsDiv.innerHTML = html;
        stepsDiv.style.display = 'block';
      } else {
        stepsDiv.style.display = 'none';
      }
    }

    /**********************
     * FAVORITES MANAGEMENT
     **********************/
    function toggleFavorite(cocktail) {
      let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
      if (favorites.includes(cocktail.idDrink)) {
        favorites = favorites.filter(id => id !== cocktail.idDrink);
        alert(`${cocktail.strDrink} removed from favorites.`);
      } else {
        favorites.push(cocktail.idDrink);
        alert(`${cocktail.strDrink} added to favorites.`);
      }
      localStorage.setItem('favorites', JSON.stringify(favorites));
      document.getElementById('favoriteBtn').textContent = favorites.includes(cocktail.idDrink) ? "Remove from Favorites" : "Add to Favorites";
    }

    /**********************
     * SOCIAL SHARING
     **********************/
    function shareCocktail(cocktail) {
      const shareData = {
        title: cocktail.strDrink,
        text: cocktail.strInstructions || "Check out this cocktail recipe!",
        url: window.location.href
      };
      if (navigator.share) {
        navigator.share(shareData)
          .then(() => console.log("Shared successfully"))
          .catch((error) => console.error("Error sharing", error));
      } else {
        const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareData.title + " - " + shareData.text)}`;
        window.open(twitterUrl, '_blank');
      }
    }

    /**********************
     * REVIEWS AND RATINGS (via localStorage)
     **********************/
    function loadReviews(cocktailId) {
      const reviewsDiv = document.getElementById('reviewDisplay');
      const reviews = JSON.parse(localStorage.getItem(`reviews_${cocktailId}`)) || [];
      if (reviews.length === 0) {
        reviewsDiv.innerHTML = "<p>No reviews yet. Be the first to review!</p>";
      } else {
        let html = "";
        let totalRating = 0;
        reviews.forEach(review => {
          totalRating += Number(review.rating);
          html += `<div class="review">
                     <p><strong>Rating:</strong> ${review.rating} Star${review.rating > 1 ? "s" : ""}</p>
                     <p>${review.text}</p>
                   </div>`;
        });
        const avgRating = (totalRating / reviews.length).toFixed(1);
        html = `<p><strong>Average Rating:</strong> ${avgRating} Stars</p>` + html;
        reviewsDiv.innerHTML = html;
      }
    }

    function submitReview(cocktailId) {
      const rating = document.getElementById('rating').value;
      const reviewText = document.getElementById('reviewText').value.trim();
      if (!rating || !reviewText) {
        alert("Please provide both a rating and a review.");
        return;
      }
      const reviews = JSON.parse(localStorage.getItem(`reviews_${cocktailId}`)) || [];
      reviews.push({ rating, text: reviewText });
      localStorage.setItem(`reviews_${cocktailId}`, JSON.stringify(reviews));
      document.getElementById('rating').value = "";
      document.getElementById('reviewText').value = "";
      loadReviews(cocktailId);
    }

    /**********************
     * FAVORITES SECTION LOADING
     **********************/
    async function loadFavorites() {
      const favoritesDiv = document.getElementById('favoritesList');
      const favorites = JSON.parse(localStorage.getItem('favorites')) || [];
      if (favorites.length === 0) {
        favoritesDiv.innerHTML = "<p>You have no favorite cocktails yet.</p>";
        return;
      }
      let html = "";
      for (const id of favorites) {
        try {
          const detailUrl = `https://www.thecocktaildb.com/api/json/v1/1/lookup.php?i=${id}`;
          const resp = await fetch(detailUrl);
          const detailData = await resp.json();
          if (detailData.drinks && detailData.drinks[0]) {
            const drink = detailData.drinks[0];
            html += `<div class="fav-item">
                       <h3>${drink.strDrink}</h3>
                       <img src="${drink.strDrinkThumb}" alt="${drink.strDrink}" style="width:100%; border-radius:8px;">
                       <button onclick="viewFavorite('${drink.idDrink}')">View Details</button>
                       <button onclick="removeFavorite('${drink.idDrink}')">Remove</button>
                     </div>`;
          }
        } catch (error) {
          console.error("Error loading favorite cocktail", error);
        }
      }
      favoritesDiv.innerHTML = html;
    }

    async function viewFavorite(idDrink) {
      const detailUrl = `https://www.thecocktaildb.com/api/json/v1/1/lookup.php?i=${idDrink}`;
      try {
        const resp = await fetch(detailUrl);
        const detailData = await resp.json();
        if (detailData.drinks && detailData.drinks[0]) {
          document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
          document.getElementById('findSection').classList.add('active');
          displayCocktail(detailData.drinks[0]);
        }
      } catch (error) {
        console.error("Error fetching favorite details", error);
      }
    }

    function removeFavorite(idDrink) {
      let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
      favorites = favorites.filter(id => id !== idDrink);
      localStorage.setItem('favorites', JSON.stringify(favorites));
      loadFavorites();
    }

    /**********************
     * ANALYTICS DASHBOARD LOADING
     **********************/
    function loadAnalytics() {
      const analyticsDiv = document.getElementById('analyticsData');
      const analytics = JSON.parse(localStorage.getItem('analytics')) || {};
      let html = `<table border="1" cellpadding="5" cellspacing="0" style="width:100%; border-collapse: collapse;">
                    <tr>
                      <th>Cocktail Name</th>
                      <th>Views</th>
                    </tr>`;
      for (const id in analytics) {
        html += `<tr>
                   <td>${analytics[id].name}</td>
                   <td>${analytics[id].views}</td>
                 </tr>`;
      }
      html += `</table>`;
      analyticsDiv.innerHTML = html;
    }
  </script>
</body>
</html>
